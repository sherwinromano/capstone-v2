{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthHub Connect | Login</title>
	<link rel="shortcut icon" href="../static/images/CTU_logo.png" type="image/x-icon">
	{% tailwind_css %}
	<link rel="stylesheet" href="{% static 'styles/base.css' %}" />
</head>
<body>
    <div class="flex w-full h-screen">
		<div class="w-1/2 xs:hidden lg:flex">
			<img class="h-full" src="../static/images/auth-image.webp" alt="Consultation image">
		</div>
		<div class="xs:w-full lg:w-1/2 flex items-center justify-center xs:p-4 md:p-14 lg:p-[8rem]">
			<div class="flex flex-col w-full gap-4">
				<div class="flex flex-col gap-2">
					<div class="self-center">
						<img class="size-[7rem]" src="../static/images/CTU_logo.png" alt="CTU Logo">
					</div>
					<div class="flex flex-col items-center">
						<h1 class="text-[1.5rem] font-bold">HealthHub Connect</h1>
						<p class="font-normal w-[70%] text-center">An Integrated Kahimsug Clinic Management System in CTU Argao</p>
					</div>
				</div>
				<form action="#" method="POST" class="flex flex-col gap-1">
					{% csrf_token %}
					<label for="email" class="text-base">Email or Student ID</label>
					<input type="text" id="email" name="email" placeholder="Enter your email or student ID" required>
					<span class="error-message" id="emailError">
						{% if messages %}
							{% for message in messages %}
								{{ message }}
							{% endfor %}
						{% endif %}
					</span>
					
					<label for="password" class="label">Password</label>
					<input type="password" id="password" name="password" placeholder="Enter your password" required>
					<span class="error-message" id="passwordError"></span>
		
					<div class="flex justify-between items-center mt-2">
						<input type="submit" value="Login" class="bg-[#3b82f6] text-white text-[14px] p-2 rounded-md w-[30%] cursor-pointer">
						<a href="{% url 'main:recovery' %}" class="text-[14px]">Forgot Password?</a>
					</div>
				</form>
				<p class="text-[14px]">Don't have an account? <a href="{% url 'main:register' %}" class="text-blue-500 underline">Register</a></p>
			</div>
		</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get the current CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(this.action, {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Welcome back!',
                    text: 'Login successful',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = data.redirect_url;
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Login Failed',
                    text: data.message
                });
            }
        })
        .catch(error => {
            // If there's a CSRF error, reload the page to get a fresh token
            if (error.message.includes('CSRF')) {
                window.location.reload();
                return;
            }
            
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong! Please try again.'
            });
        });
    });
    </script>
</body>
</html>
